<?php
abstract class BasicController {
	protected $subModule = "";
	protected $_conn;
    /**
     * @var BasicView
     */
	protected $_view;
	protected $_request;
	protected $_response;
	protected $_action;
	protected $_session;
	protected $_module;
	protected $_url;
    private $_context;
	private $viewGenerate = true;
	public function __construct(Request $request) {
		$this->_request = $request;
		$this->_session = HttpSession::getSession ();
		if ($this->getParam ( "logged_user", false )) {
			$this->_session->setAttribute ( "user_id", $this->getParam ( "user_id", 0 ) );
			$this->_session->setAttribute ( "logged_user", true );
		}
		$this->_context = Application::getInstance()->getContext();
		$this->_view = new BasicView($this->_context);
		$this->_response = new Response ();
		$this->_view->redirect = $this->_url;
        $this->_view->mUpdateDate = $this->_context->getParam("build", "updateDate");
        $this->_view->mBuildVersion = $this->_context->getParam("build", "version");
		$this->initAll ();
		
		if ($this->_session->isSetAttr ( "message" )) {
			$this->_view->message = $this->showMessage ();
		}
	}
	protected function initAll() {
	}
	public function __call($name, $arg) {
		header ( "Content-Type: text/html; charset=UTF-8" );
		echo "Metoda " . $name . " nie jest obsługiwana";
		die ();
	}
	
	/**
	 *
	 * @access general
	 */
	public function accessDeniedAction() {
		echo "Nie masz dostępu do tej części witryny";
		die ();
	}
	public function setSubModuleAdmin() {
		$path = $this->_module . "/view/" . $this->subModule . "/admin/" . $this->_action . ".php";
		$this->setView ( $path );
	}
	public function setSubModuleFront() {
		$path = $this->_module . "/view/" . $this->subModule . "/" . $this->_action . ".php";
		$this->setView ( $path );
	}
	public function dispatch($action) {
		$this->setHeader ( "Content-Type: text/html; charset=utf-8" );
		$this->_action = $action;
		if ($message = $this->getParam ( "message", "" ) != "") {
			$this->_view->message = $message;
		}
		if (! $this->checkPrivilage ()) {
			$action = "accessDenied";
			$this->setView ( "/layouts/accessDennied.php" );
		}
		
		$path = $this->getViewPath ();
		$this->setView ( $path );
		
		$fun = $action . "Action";
		$this->$fun ();
		$this->_action = $action;
		$this->showView ();
	}
	protected function showView() {
		if ($this->viewGenerate)
			$this->_view->draw();
	}
	public function getParametersMap() {
		return $this->_request->getParametersMap ();
	}
	public function getParam($id, $default = "") {
		return $this->_request->getParam ( $id, $default );
	}
	public function setView($path) {
		$this->_view->setView ( $path );
	}
	public function getMethod() {
		return $this->_request->getMethod ();
	}
	public function setMessage($message) {
		$this->_session->setAttribute ( "message", $message );
	}
	public function appendMessage($message) {
		$old_message = $this->_session->getAttribute ( "message" );
		$this->_session->setAttribute ( "message", $old_message . " " . $message );
	}
	public function showMessage() {
		if ($this->_session->isSetAttr ( "message" )) {
			$ret = $this->_session->getAttribute ( "message" );
			$this->_session->clearAttribute ( "message" );
			return $ret;
		}
		return "";
	}
	public function forward($url, $msg = "") {
		if ($msg != "") {
			$tab = explode ( "=", $msg );
			$this->_session->setAttribute ( $tab [0], $tab [1] );
		}
		
		header ( "Location: /" . $url );
	}
	public function getUrl() {
		return $this->_url;
	}
	public function setUrl($url) {
		$this->_url = $url;
	}
	public function setHeader($string) {
		header ( $string );
	}
	public function isUserLogged() {
		$user = User::getLoggedUser ();
		return $user->isLogged ();
	}
	public function checkPrivilage() {
		$priv = $this->_context->getParam( $this->_module, $this->_action );
        if ($priv != null) {
			return $priv;
		} else {
			return User::getLoggedUser ()->checkPrivilage ( $this->_module, $this->_action );
		}
	}
	
	/**
	 *
	 * @param boolean $generate
	 */
	public function setViewGenerete($generate) {
		$this->viewGenerate = $generate;
	}
	public abstract function getViewPath();
}